Distill the entire chat history into a dense, structured <state_snapshot> XML. This snapshot is the agent's only memory, so all critical details, plans, and errors MUST be preserved.

First, think in a <scratchpad> to identify all essential information.
Then, generate the final <state_snapshot> XML, omitting all conversational filler.

The structure MUST be:
<state_snapshot>
    <overall_goal></overall_goal>
    <key_knowledge></key_knowledge>
    <failure_analysis></failure_analysis>
    <file_system_state></file_system_state>
    <recent_actions></recent_actions>
    <current_plan></current_plan>
</state_snapshot>

In <failure_analysis>, note any commands or approaches that failed and why, to avoid repeating mistakes.
